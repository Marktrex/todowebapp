<!DOCTYPE html>
<html>
<head>
  <title>Todo</title>
</head>
<body>
    <h1>My Todo List</h1>
    <button onclick="logout()">Logout</button>
    <button onclick="goSettings()">Settings</button>

    <ul id="todos"></ul>

    <input type="text" id="todoInput" placeholder="New todo">
    <button onclick="addTodo()">Add</button>

    <script>
    const token = localStorage.getItem("token");
    if(!token) window.location.href = "login.html";

    async function fetchTodos(){
    const res = await fetch("http://localhost:3000/todo", {
        headers:{ "Authorization":"Bearer " + token }
    });
    const data = await res.json();
    const ul = document.getElementById("todos");
    ul.innerHTML = "";
    data.forEach(todo => {
        const li = document.createElement("li");
        li.textContent = todo.text;
        li.onclick = ()=>editTodo(todo);
        const del = document.createElement("button");
        del.textContent = "Delete";
        del.onclick = ()=>deleteTodo(todo._id);
        li.appendChild(del);
        ul.appendChild(li);
    });
    }

    async function addTodo(){
    const text = document.getElementById("todoInput").value;
    await fetch("http://localhost:3000/todo", {
        method:"POST",
        headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer "+token
        },
        body: JSON.stringify({text})
    });
    document.getElementById("todoInput").value = "";
    fetchTodos();
    }

    async function editTodo(todo){
    const newText = prompt("Edit todo", todo.text);
    if(!newText) return;
    await fetch(`http://localhost:3000/todo/${todo._id}`, {
        method:"PUT",
        headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer "+token
        },
        body: JSON.stringify({text:newText})
    });
    fetchTodos();
    }

    async function deleteTodo(id){
    await fetch(`http://localhost:3000/todo/${id}`, {
        method:"DELETE",
        headers:{
        "Authorization":"Bearer "+token
        }
    });
    fetchTodos();
    }

    function logout(){
    localStorage.removeItem("token");
    window.location.href = "login.html";
    }

    function goSettings(){
    window.location.href = "settings.html";
    }

    // fetch todos on load
    fetchTodos();
    </script>

</body>
</html>
